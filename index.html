<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paket Production Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-top: 6px solid #1e40af;
        }
        
        .header h1 {
            color: #1e3a8a;
            font-size: 32px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo {
            color: #1e40af;
            font-weight: 800;
            font-size: 28px;
        }
        
        .header p {
            color: #64748b;
            font-size: 14px;
        }
        
        .updated {
            color: #16a34a;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }
        
        .goal-banner {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            margin-top: 16px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .toggle {
            background: #f1f5f9;
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            transition: all 0.3s;
        }
        
        .toggle:hover {
            background: #e2e8f0;
        }
        
        .toggle span {
            color: #1e40af;
            font-weight: 600;
        }
        
        .toggle-content {
            display: none;
            padding: 12px 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 8px;
            color: #475569;
            font-size: 14px;
        }
        
        .toggle-content.show {
            display: block;
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3b82f6;
        }
        
        .label {
            color: #64748b;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }
        
        .value {
            font-size: 32px;
            font-weight: 700;
            color: #1e3a8a;
        }
        
        .trend {
            font-size: 12px;
            margin-top: 8px;
        }
        
        .down { color: #dc2626; }
        .up { color: #16a34a; }
        
        .chart-box {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 20px;
        }
        
        .chart-subtitle {
            font-size: 13px;
            color: #64748b;
            margin-top: -12px;
            margin-bottom: 16px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: #f1f5f9;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: #475569;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            text-transform: uppercase;
        }
        
        td {
            color: #1e293b;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .good {
            background: #d1fae5;
            color: #065f46;
        }
        
        .warn {
            background: #fef3c7;
            color: #92400e;
        }
        
        .bad {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .tip {
            background: #fef2f2;
            border-left: 4px solid #dc2626;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        
        .tip-good {
            background: #f0fdf4;
            border-left-color: #16a34a;
        }
        
        .tip-warn {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }
        
        .tip-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 4px;
        }
        
        .tip-detail {
            font-size: 13px;
            color: #64748b;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .filter-box {
            margin-bottom: 20px;
        }
        
        .filter-box select {
            padding: 12px;
            font-size: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-width: 300px;
        }
        
        .filter-box select:hover {
            border-color: #3b82f6;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1><span class="logo">PAKET</span> Production Efficiency Dashboard</h1>
        <p>Analysis Period: October 2025 - January 2026 | 471 Runs | 91 SKUs | 25 Lines</p>
        <div class="updated">üìÖ Last Updated: January 25, 2026 at 4:57 PM CST</div>
        <div class="goal-banner">üéØ Goal: ‚â•85% Efficiency | Weekly Focus: Jan 19-25, 2026</div>
        <div class="toggle" onclick="toggleQuality()">
            <span>üìä Data Quality</span>
            <span id="toggleIcon">‚ñº</span>
        </div>
        <div class="toggle-content" id="qualityContent">
            <strong>Standardization:</strong> Lines: 33‚Üí25 | SKUs: 98‚Üí91<br>
            Consolidated BTL variants, ELGIN variants, standardized DUKCAN/TRIPRO naming
        </div>
    </div>

    <div class="metrics">
        <div class="card">
            <div class="label">Avg Efficiency</div>
            <div class="value">79.8%</div>
            <div class="trend down">‚Üì Oct: 84% ‚Üí Jan: 76%</div>
        </div>
        <div class="card">
            <div class="label">Last Week</div>
            <div class="value">84.5%</div>
            <div class="trend up">‚Üë Close to goal!</div>
        </div>
        <div class="card">
            <div class="label">Lost Minutes</div>
            <div class="value">22,787</div>
            <div class="trend down">‚Üë 4,671 ‚Üí 6,267/mo</div>
        </div>
        <div class="card">
            <div class="label">Database</div>
            <div class="value">91</div>
            <div class="trend" style="color:#64748b">SKUs tracked</div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('overview')">Overview</button>
        <button class="tab" onclick="switchTab('weekly')">Weekly Detail</button>
        <button class="tab" onclick="switchTab('ops')">Operators</button>
        <button class="tab" onclick="switchTab('tips')">Insights</button>
        <button class="tab" onclick="switchTab('mgr')">Manager View</button>
        <button class="tab" onclick="switchTab('historical')">Historical Analysis</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
        <div class="chart-box">
            <div class="chart-title">Data Source Information</div>
            <div class="tip tip-good">
                <div class="tip-title">üìÖ Data Collection: October 2025 - January 2026 (4 months)</div>
                <div class="tip-detail">
                    ‚Ä¢ <strong>Runs:</strong> 471 total | <strong>Lines:</strong> 25 tracked | <strong>SKUs:</strong> 91 analyzed | <strong>Recent:</strong> Week of Jan 19-25 (31 runs)
                </div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="chart-box">
                <div class="chart-title">Monthly Efficiency vs Goal</div>
                <canvas id="monthlyEffChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Monthly Lost Minutes</div>
                <div class="chart-subtitle">Hover to see % of total available time</div>
                <canvas id="monthlyLostChart"></canvas>
            </div>
        </div>
        
        <div class="chart-box">
            <div class="chart-title">Line Efficiency</div>
            <canvas id="lineEffChart"></canvas>
        </div>
        
        <div class="chart-box">
            <div class="chart-title">Line Run Counts</div>
            <canvas id="lineRunsChart"></canvas>
        </div>
    </div>

    <!-- Weekly Detail Tab -->
    <div id="weekly" class="tab-content">
        <div class="chart-box">
            <div class="chart-title">Week of Jan 19-25, 2026 - Daily Performance</div>
            <canvas id="weeklyEffChart"></canvas>
        </div>
        
        <div class="grid-2">
            <div class="chart-box">
                <div class="chart-title">Daily Units Produced</div>
                <canvas id="weeklyUnitsChart"></canvas>
            </div>
            <div class="chart-box">
                <div class="chart-title">Total Labor Count Per Day</div>
                <div class="chart-subtitle">Sum of all workers across all lines</div>
                <canvas id="weeklyLaborChart"></canvas>
            </div>
        </div>
        
        <div class="chart-box">
            <div class="chart-title">üìä SKUs Run This Week (31 runs)</div>
            <table id="weeklySKUTable"></table>
        </div>
    </div>

    <!-- Operators Tab -->
    <div id="ops" class="tab-content">
        <div class="chart-box">
            <div class="chart-title">All Operators (Min 5 Runs)</div>
            <canvas id="operatorsChart"></canvas>
        </div>
        <div class="chart-box">
            <table id="operatorsTable"></table>
        </div>
    </div>

    <!-- Insights Tab -->
    <div id="tips" class="tab-content">
        <div class="chart-box">
            <div class="chart-title">üîß Root Cause Analysis & Action Items</div>
            
            <div class="tip">
                <div class="tip-title">1. Material Shortages ‚≠ê #1 Issue</div>
                <div class="tip-detail">
                    <strong>Frequency:</strong> Very High (20+ occurrences)<br>
                    üí° <strong>Actions:</strong> (1) +20% min inventory, (2) 2-day lookahead scheduling, (3) Daily material meetings, (4) Buffer for top 10 SKUs
                </div>
            </div>
            
            <div class="tip">
                <div class="tip-title">2. Pump Failures</div>
                <div class="tip-detail">
                    <strong>Frequency:</strong> High<br>
                    üí° <strong>Actions:</strong> (1) Weekly PM, (2) Backup pump, (3) Operator training, (4) Track hours
                </div>
            </div>
            
            <div class="tip">
                <div class="tip-title">3. Capper Problems</div>
                <div class="tip-detail">
                    <strong>Frequency:</strong> High<br>
                    üí° <strong>Actions:</strong> (1) Root cause analysis, (2) Stock parts, (3) Monthly calibration
                </div>
            </div>
        </div>
        
        <div class="chart-box">
            <div class="chart-title">‚úÖ Success Patterns</div>
            <div class="tip tip-good">
                <div class="tip-title">TRUFRE Series: Consistent 90%+</div>
                <div class="tip-detail">Multiple SKUs performing excellently - audit for best practices</div>
            </div>
        </div>
    </div>

    <!-- Manager View Tab -->
    <div id="mgr" class="tab-content">
        <div class="chart-box">
            <div class="chart-title">üìà Plant Manager Recommendations</div>
            
            <div class="tip tip-good">
                <div class="tip-title">1. SKU Rationalization</div>
                <div class="tip-detail">
                    Review bottom 10 performers. If &lt;70% efficiency persists, evaluate profitability vs complexity.
                </div>
            </div>
            
            <div class="tip tip-good">
                <div class="tip-title">2. Focus on High-Volume Winners</div>
                <div class="tip-detail">
                    Top 15 SKUs = 48% of all runs. Ensure: (1) Dedicated line optimization, (2) PM priority, (3) Best operator assignments.
                </div>
            </div>
            
            <div class="tip tip-good">
                <div class="tip-title">3. Historical Benchmarking</div>
                <div class="tip-detail">
                    Use max efficiency achieved for each SKU as "art of the possible" benchmark.
                </div>
            </div>
        </div>
        
        <div class="chart-box">
            <div class="chart-title">Highest Downtime SKUs</div>
            <canvas id="downtimeChart"></canvas>
        </div>
    </div>

    <!-- Historical Analysis Tab -->
    <div id="historical" class="tab-content">
        <div class="grid-2">
            <div class="chart-box">
                <div class="chart-title">üîç SKU Historical Performance Lookup</div>
                <div class="chart-subtitle">All 91 SKUs available - select to view detailed analysis</div>
                <div class="filter-box">
                    <select id="skuFilter" onchange="filterSKU()">
                        <option value="">-- Select SKU --</option>
                    </select>
                </div>
                <div id="skuDetails"></div>
            </div>
            
            <div class="chart-box">
                <div class="chart-title">üè≠ Line/Machine Historical Performance Lookup</div>
                <div class="chart-subtitle">All 25 production lines - select to view detailed analysis</div>
                <div class="filter-box">
                    <select id="lineFilter" onchange="filterLine()">
                        <option value="">-- Select Line --</option>
                    </select>
                </div>
                <div id="lineDetails"></div>
            </div>
        </div>
        
        <div class="grid-2">
            <div class="chart-box">
                <div class="chart-title">Top 10 Historical Performers (SKUs)</div>
                <div class="chart-subtitle">Min 5 runs, sorted by avg efficiency</div>
                <table id="topHistTable"></table>
            </div>
            
            <div class="chart-box">
                <div class="chart-title">Bottom 10 Historical Performers (SKUs)</div>
                <div class="chart-subtitle">Chronic underperformers requiring attention</div>
                <table id="botHistTable"></table>
            </div>
        </div>
        
        <div class="chart-box">
            <div class="chart-title">üí° Historical vs Current Performance Analysis</div>
            
            <div class="tip tip-good">
                <div class="tip-title">‚úÖ Improving SKUs (Current > Historical Avg)</div>
                <div class="tip-detail" id="improvingList"></div>
            </div>
            
            <div class="tip">
                <div class="tip-title">‚ö†Ô∏è Declining SKUs (Current < Historical Avg)</div>
                <div class="tip-detail" id="decliningList"></div>
            </div>
            
            <div class="tip tip-good">
                <div class="tip-title">üè≠ Best Performing Lines (Historical Avg ‚â•85%)</div>
                <div class="tip-detail" id="bestLinesList"></div>
            </div>
            
            <div class="tip">
                <div class="tip-title">üîß Lines Needing Attention (Historical Avg <75%)</div>
                <div class="tip-detail" id="problemLinesList"></div>
            </div>
        </div>
        
        <div class="chart-box">
            <div class="chart-title">üìä Key Historical Insights</div>
            
            <div class="tip tip-warn">
                <div class="tip-title">Consistency Leaders (Low Variability)</div>
                <div class="tip-detail">
                    <strong>DAPBAB-01V1, TRUFRE-04, TRUFRE-06</strong> - Narrow speed ranges and consistent efficiency. Use as models for process standardization.
                </div>
            </div>
            
            <div class="tip">
                <div class="tip-title">Chronic Problems Requiring Investment</div>
                <div class="tip-detail">
                    <strong>DUKCAN-17</strong> (22 runs, 58% avg, declining to 49% recently) - Never performed well. Consider discontinue or major process redesign.
                </div>
            </div>
            
            <div class="tip tip-good">
                <div class="tip-title">Volume + Performance = Revenue Drivers</div>
                <div class="tip-detail">
                    <strong>DAPBAB-01V1</strong> (24 runs, 93%, 467k units) and <strong>TRUFRE-01</strong> (40 runs, 402k units) - Prioritize capacity expansion.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Load external data -->
<script src="data/paket_data.js"></script>

<!-- Dashboard JavaScript -->
<script>
// ===== STATIC DATA =====
const monthlyData = {
    labels: ['Oct', 'Nov', 'Dec', 'Jan'],
    efficiency: [84.1, 79.6, 79.3, 76.1],
    lostMinutes: [4671, 4917, 6931, 6267],
    totalMinutes: [43796, 38032, 53381, 40432],
    lostPct: [10.7, 12.9, 13.0, 15.5]
};

const lineData = {
    names: ['B4', 'P1', 'P2', 'B1', 'BOTTLE LINE II', 'B3', 'ELGIN I', 'BOTTLE LINE', 'PSG', 'B6', 'KALIX I', 'ELGIN II', 'KALIX II', 'B5', 'REB'],
    efficiency: [93.1, 91.9, 90.9, 90.1, 89.2, 87.7, 86.4, 86.3, 83.3, 78.0, 75.2, 72.2, 68.6, 64.1, 62.8],
    runs: [27, 12, 23, 77, 7, 9, 53, 12, 46, 59, 16, 16, 32, 8, 35]
};

const operatorData = {
    names: ['GLORIA', 'EVA', 'NELLY', 'NORMA', 'ROCIO M', 'LINDA', 'MARTIN', 'KARLA', 'CHUYA', 'SERENA', 'ANDY'],
    efficiency: [86.0, 83.1, 82.8, 81.8, 81.4, 80.3, 80.3, 78.8, 77.4, 73.5, 72.9],
    runs: [36, 60, 63, 22, 43, 16, 38, 49, 64, 30, 46]
};

const weeklyData = {
    daily: {
        '01/19': { day: 'Monday', runs: 5, efficiency: 91.0, units: 31900, total_labor: 12 },
        '01/20': { day: 'Tuesday', runs: 6, efficiency: 100.0, units: 74812, total_labor: 24 },
        '01/21': { day: 'Wednesday', runs: 6, efficiency: 93.0, units: 72234, total_labor: 22 },
        '01/22': { day: 'Thursday', runs: 8, efficiency: 77.0, units: 63973, total_labor: 31 },
        '01/23': { day: 'Friday', runs: 6, efficiency: 65.0, units: 39745, total_labor: 32 }
    },
    by_sku: {
        'TRUFRE-06': { runs: 5, efficiency: 97.0, units: 47800, labor: 2.0, lost_mins: 14.5, lines: 'B1' },
        'RAWSUG 02': { runs: 5, efficiency: 89.0, units: 79210, labor: 2.0, lost_mins: 194.3, lines: 'B4' },
        'DUKCAN-11': { runs: 4, efficiency: 95.0, units: 40041, labor: 7.5, lost_mins: 84.8, lines: 'ELGIN I' },
        'DUKCAN-17': { runs: 3, efficiency: 49.0, units: 15103, labor: 7.0, lost_mins: 422.0, lines: 'REB' },
        'RAWSUG 01': { runs: 3, efficiency: 71.0, units: 18600, labor: 2.0, lost_mins: 190.8, lines: 'B5' }
    }
};

const downtimeData = {
    items: ['DUKCAN-17', 'TRUFRE-01', 'DAPBAB-04V2', 'DUKCAN-18', 'PACTEC-06G'],
    mins: [2263, 1808, 1272, 1105, 703]
};

const topPerformers = [
    { sku: 'DUKCAN-01V1', eff: 95.0, runs: 7, lines: 'ELGIN I', speed: 28.1 },
    { sku: 'TRUFRE-06', eff: 95.0, runs: 15, lines: 'B1', speed: 28.9 },
    { sku: 'TRUFRE-04', eff: 93.0, runs: 14, lines: 'B1', speed: 30.0 },
    { sku: 'DAPBAB-01V1', eff: 93.0, runs: 24, lines: 'P2, P1', speed: 68.0 },
    { sku: 'BOOGIE-02', eff: 93.0, runs: 13, lines: 'B4', speed: 34.2 },
    { sku: 'DUKCAN-05V1', eff: 92.0, runs: 11, lines: 'ELGIN I', speed: 27.8 },
    { sku: 'TRUFRE-05', eff: 91.0, runs: 13, lines: 'B1', speed: 29.8 },
    { sku: 'BOOGIE-01', eff: 89.0, runs: 13, lines: 'BOTTLE LINE', speed: 31.1 },
    { sku: 'DAPBAB-04V2', eff: 85.0, runs: 32, lines: 'PSG', speed: 10.8 },
    { sku: 'TRUFRE-01', eff: 78.0, runs: 40, lines: 'B6', speed: 44.0 }
];

const bottomPerformers = [
    { sku: 'PACTEC-06G', eff: 47.0, runs: 5, lines: 'P3, PD3', speed: 12.0 },
    { sku: 'FUCHSL-11', eff: 51.0, runs: 5, lines: 'KENTEX', speed: 26.4 },
    { sku: 'DUKCAN-17', eff: 58.0, runs: 22, lines: 'REB', speed: 34.9 },
    { sku: 'TRUFRE-12', eff: 59.0, runs: 5, lines: 'B1', speed: 29.0 },
    { sku: 'PURPRO-01', eff: 60.0, runs: 5, lines: 'B5', speed: 26.0 },
    { sku: 'OKECOM-07', eff: 66.0, runs: 5, lines: 'REB', speed: 35.0 },
    { sku: 'DUKCAN-18', eff: 69.0, runs: 14, lines: 'KALIX II', speed: 46.9 },
    { sku: 'DUKCAN-07V1', eff: 70.0, runs: 8, lines: 'KALIX I', speed: 44.0 },
    { sku: 'PACTEC-01G', eff: 70.0, runs: 11, lines: 'P3', speed: 12.7 },
    { sku: 'DAPBAB-26', eff: 70.0, runs: 6, lines: 'PSG', speed: 10.5 }
];

// ===== COLORS =====
const colors = {
    primary: '#1e40af',
    secondary: '#3b82f6',
    ok: '#16a34a',
    warn: '#f59e0b',
    bad: '#dc2626',
    goal: '#7c3aed'
};

// ===== CHART PLUGIN: GOAL LINE =====
const goalLinePlugin = {
    id: 'goalLine',
    afterDatasetsDraw(chart) {
        const { ctx, chartArea: { left, right }, scales: { y } } = chart;
        if (!y) return;
        
        const goalValue = y.getPixelForValue(85);
        
        ctx.save();
        ctx.strokeStyle = colors.goal;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(left, goalValue);
        ctx.lineTo(right, goalValue);
        ctx.stroke();
        
        ctx.fillStyle = colors.goal;
        ctx.font = 'bold 12px sans-serif';
        ctx.fillText('Goal: 85%', right - 70, goalValue - 5);
        ctx.restore();
    }
};

// ===== UTILITY FUNCTIONS =====
function toggleQuality() {
    const content = document.getElementById('qualityContent');
    const icon = document.getElementById('toggleIcon');
    content.classList.toggle('show');
    icon.textContent = content.classList.contains('show') ? '‚ñ≤' : '‚ñº';
}

function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
}

function filterSKU() {
    const selected = document.getElementById('skuFilter').value;
    const details = document.getElementById('skuDetails');
    
    if (!selected) {
        details.innerHTML = '<p style="color:#64748b;margin-top:20px">Select a SKU to view detailed historical performance</p>';
        return;
    }
    
    const sku = allData.skus[selected];
    const gap = 85 - sku.avg_eff;
    const status = sku.avg_eff >= 85 ? 'good' : sku.avg_eff >= 75 ? 'warn' : 'bad';
    const trend = sku.recent_eff ? (sku.recent_eff > sku.avg_eff ? '‚ÜóÔ∏è Improving' : '‚ÜòÔ∏è Declining') : 'No recent data';
    
    details.innerHTML = `
        <div class="tip tip-good" style="margin-top:20px">
            <div class="tip-title">${selected} - Historical Performance Summary</div>
            <div class="tip-detail">
                <strong>Total Runs:</strong> ${sku.runs} | <strong>Total Output:</strong> ${sku.total_output.toLocaleString()} units<br>
                <strong>Average Efficiency:</strong> <span class="badge ${status}">${sku.avg_eff}%</span> (${gap > 0 ? gap.toFixed(1) + '% below goal' : 'above goal'})<br>
                <strong>Performance Range:</strong> ${sku.min_eff}% (worst) to ${sku.max_eff}% (best) - ${(sku.max_eff - sku.min_eff).toFixed(1)}% spread<br>
                <strong>Speed Range (CPM):</strong> ${sku.min_speed} - ${sku.max_speed} cycles/min (Avg: ${sku.avg_speed} CPM)<br>
                <strong>Average Manning:</strong> ${sku.avg_manning} workers per run<br>
                <strong>Primary Lines:</strong> ${sku.top_lines}<br>
                <strong>Total Lost Minutes:</strong> ${sku.total_lost_mins.toLocaleString()} mins<br>
                ${sku.recent_eff ? `<strong>Recent Performance:</strong> ${sku.recent_eff}% in last month (${sku.recent_runs} runs) ${trend}<br>` : ''}
                <br>
                üí° <strong>Opportunity:</strong> If all runs matched best (${sku.max_eff}%), efficiency would improve by ${(sku.max_eff - sku.avg_eff).toFixed(1)}pp.
            </div>
        </div>
    `;
}

function filterLine() {
    const selected = document.getElementById('lineFilter').value;
    const details = document.getElementById('lineDetails');
    
    if (!selected) {
        details.innerHTML = '<p style="color:#64748b;margin-top:20px">Select a line to view detailed historical performance</p>';
        return;
    }
    
    const line = allData.lines[selected];
    const gap = 85 - line.avg_eff;
    const status = line.avg_eff >= 85 ? 'good' : line.avg_eff >= 75 ? 'warn' : 'bad';
    const trend = line.recent_eff ? (line.recent_eff > line.avg_eff ? '‚ÜóÔ∏è Improving' : '‚ÜòÔ∏è Declining') : 'No recent data';
    
    details.innerHTML = `
        <div class="tip tip-good" style="margin-top:20px">
            <div class="tip-title">${selected} - Line Historical Performance</div>
            <div class="tip-detail">
                <strong>Total Runs:</strong> ${line.runs} | <strong>Total Output:</strong> ${line.total_output.toLocaleString()} units<br>
                <strong>Average Efficiency:</strong> <span class="badge ${status}">${line.avg_eff}%</span> (${gap > 0 ? gap.toFixed(1) + '% below goal' : 'above goal'})<br>
                <strong>Performance Range:</strong> ${line.min_eff}% (worst) to ${line.max_eff}% (best) - ${(line.max_eff - line.min_eff).toFixed(1)}% spread<br>
                <strong>Speed Range (CPM):</strong> ${line.min_speed} - ${line.max_speed} cycles/min (Avg: ${line.avg_speed} CPM)<br>
                <strong>Top SKUs Run:</strong> ${line.top_skus}<br>
                <strong>Total Lost Minutes:</strong> ${line.total_lost_mins.toLocaleString()} mins<br>
                ${line.recent_eff ? `<strong>Recent Performance:</strong> ${line.recent_eff}% in last month (${line.recent_runs} runs) ${trend}<br>` : ''}
                <br>
                üí° <strong>Opportunity:</strong> If all runs matched best (${line.max_eff}%), efficiency would improve by ${(line.max_eff - line.avg_eff).toFixed(1)}pp.
            </div>
        </div>
    `;
}

// ===== INITIALIZE CHARTS =====
function initCharts() {
    // Monthly Efficiency Chart
    new Chart(document.getElementById('monthlyEffChart'), {
        type: 'line',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                data: monthlyData.efficiency,
                borderColor: colors.primary,
                backgroundColor: colors.primary + '20',
                tension: 0.4,
                fill: true,
                borderWidth: 3
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    min: 70,
                    max: 90,
                    ticks: { callback: v => v + '%' }
                }
            }
        },
        plugins: [goalLinePlugin]
    });
    
    // Monthly Lost Minutes Chart
    new Chart(document.getElementById('monthlyLostChart'), {
        type: 'bar',
        data: {
            labels: monthlyData.labels,
            datasets: [{
                data: monthlyData.lostMinutes,
                backgroundColor: colors.bad
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(ctx) {
                            const idx = ctx.dataIndex;
                            return `Lost: ${monthlyData.lostMinutes[idx].toLocaleString()} mins (${monthlyData.lostPct[idx]}% of ${monthlyData.totalMinutes[idx].toLocaleString()} total)`;
                        }
                    }
                }
            }
        }
    });
    
    // Line Efficiency Chart
    new Chart(document.getElementById('lineEffChart'), {
        type: 'bar',
        data: {
            labels: lineData.names,
            datasets: [{
                data: lineData.efficiency,
                backgroundColor: lineData.efficiency.map(e => e >= 85 ? colors.ok : e >= 75 ? colors.warn : colors.bad)
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: {
                    max: 100,
                    ticks: { callback: v => v + '%' }
                }
            }
        }
    });
    
    // Line Runs Chart
    new Chart(document.getElementById('lineRunsChart'), {
        type: 'bar',
        data: {
            labels: lineData.names,
            datasets: [{
                data: lineData.runs,
                backgroundColor: colors.secondary
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { legend: { display: false } }
        }
    });
    
    // Weekly Efficiency Chart
    const weekDays = Object.keys(weeklyData.daily).sort();
    new Chart(document.getElementById('weeklyEffChart'), {
        type: 'bar',
        data: {
            labels: weekDays.map(k => weeklyData.daily[k].day),
            datasets: [{
                data: weekDays.map(k => weeklyData.daily[k].efficiency),
                backgroundColor: weekDays.map(k => {
                    const e = weeklyData.daily[k].efficiency;
                    return e >= 85 ? colors.ok : e >= 75 ? colors.warn : colors.bad;
                })
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    min: 60,
                    max: 105,
                    ticks: { callback: v => v + '%' }
                }
            }
        },
        plugins: [goalLinePlugin]
    });
    
    // Weekly Units Chart
    new Chart(document.getElementById('weeklyUnitsChart'), {
        type: 'bar',
        data: {
            labels: weekDays.map(k => weeklyData.daily[k].day),
            datasets: [{
                data: weekDays.map(k => weeklyData.daily[k].units),
                backgroundColor: colors.secondary
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
    
    // Weekly Labor Chart
    new Chart(document.getElementById('weeklyLaborChart'), {
        type: 'bar',
        data: {
            labels: weekDays.map(k => weeklyData.daily[k].day),
            datasets: [{
                data: weekDays.map(k => weeklyData.daily[k].total_labor),
                backgroundColor: colors.primary
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
    
    // Operators Chart
    new Chart(document.getElementById('operatorsChart'), {
        type: 'bar',
        data: {
            labels: operatorData.names,
            datasets: [{
                data: operatorData.efficiency,
                backgroundColor: operatorData.efficiency.map(e => e >= 85 ? colors.ok : colors.warn)
            }]
        },
        options: {
            responsive: true,
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
                x: {
                    min: 70,
                    max: 90,
                    ticks: { callback: v => v + '%' }
                }
            }
        },
        plugins: [goalLinePlugin]
    });
    
    // Downtime Chart
    new Chart(document.getElementById('downtimeChart'), {
        type: 'bar',
        data: {
            labels: downtimeData.items,
            datasets: [{
                data: downtimeData.mins,
                backgroundColor: colors.bad
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } }
        }
    });
}

// ===== POPULATE TABLES =====
function populateTables() {
    // Operators Table
    let opHTML = '<thead><tr><th>Rank</th><th>Operator</th><th>Runs</th><th>Efficiency</th><th>vs Goal</th></tr></thead><tbody>';
    operatorData.names.forEach((name, i) => {
        const eff = operatorData.efficiency[i];
        const status = eff >= 85 ? 'good' : 'warn';
        opHTML += `
            <tr>
                <td>${i + 1}</td>
                <td><strong>${name}</strong></td>
                <td>${operatorData.runs[i]}</td>
                <td>${eff}%</td>
                <td><span class="badge ${status}">${eff >= 85 ? 'Above' : 'Below'}</span></td>
            </tr>
        `;
    });
    opHTML += '</tbody>';
    document.getElementById('operatorsTable').innerHTML = opHTML;
    
    // Weekly SKU Table
    let skuHTML = '<thead><tr><th>SKU</th><th>Runs</th><th>Units</th><th>Efficiency</th><th>Labor</th><th>Lost Mins</th><th>Lines</th></tr></thead><tbody>';
    Object.entries(weeklyData.by_sku).forEach(([sku, data]) => {
        const status = data.efficiency >= 85 ? 'good' : data.efficiency >= 75 ? 'warn' : 'bad';
        skuHTML += `
            <tr>
                <td><strong>${sku}</strong></td>
                <td>${data.runs}</td>
                <td>${data.units.toLocaleString()}</td>
                <td><span class="badge ${status}">${data.efficiency}%</span></td>
                <td>${data.labor}</td>
                <td>${data.lost_mins}</td>
                <td>${data.lines}</td>
            </tr>
        `;
    });
    skuHTML += '</tbody>';
    document.getElementById('weeklySKUTable').innerHTML = skuHTML;
    
    // Top Performers Table
    let topHTML = '<thead><tr><th>SKU</th><th>Runs</th><th>Avg Eff</th><th>Primary Line</th><th>Avg Speed (CPM)</th></tr></thead><tbody>';
    topPerformers.forEach(p => {
        topHTML += `
            <tr>
                <td><strong>${p.sku}</strong></td>
                <td>${p.runs}</td>
                <td><span class="badge good">${p.eff}%</span></td>
                <td>${p.lines}</td>
                <td>${p.speed}</td>
            </tr>
        `;
    });
    topHTML += '</tbody>';
    document.getElementById('topHistTable').innerHTML = topHTML;
    
    // Bottom Performers Table
    let botHTML = '<thead><tr><th>SKU</th><th>Runs</th><th>Avg Eff</th><th>Primary Line</th><th>Avg Speed (CPM)</th></tr></thead><tbody>';
    bottomPerformers.forEach(p => {
        botHTML += `
            <tr>
                <td><strong>${p.sku}</strong></td>
                <td>${p.runs}</td>
                <td><span class="badge bad">${p.eff}%</span></td>
                <td>${p.lines}</td>
                <td>${p.speed}</td>
            </tr>
        `;
    });
    botHTML += '</tbody>';
    document.getElementById('botHistTable').innerHTML = botHTML;
}

// ===== POPULATE DROPDOWNS (THE FIX!) =====
function populateDropdowns() {
    const skuFilter = document.getElementById('skuFilter');
    const lineFilter = document.getElementById('lineFilter');
    
    // **CRITICAL FIX**: Load ALL 91 SKUs (not just 10)
    Object.keys(allData.skus).sort().forEach(sku => {
        const opt = document.createElement('option');
        opt.value = sku;
        opt.textContent = `${sku} (${allData.skus[sku].runs} runs, ${allData.skus[sku].avg_eff}%)`;
        skuFilter.appendChild(opt);
    });
    
    // **CRITICAL FIX**: Load ALL 25 lines (not just 5)
    Object.keys(allData.lines).sort().forEach(line => {
        const opt = document.createElement('option');
        opt.value = line;
        opt.textContent = `${line} (${allData.lines[line].runs} runs, ${allData.lines[line].avg_eff}%)`;
        lineFilter.appendChild(opt);
    });
}

// ===== POPULATE ANALYSIS LISTS =====
function populateAnalysisLists() {
    // Find improving and declining SKUs
    let improving = [];
    let declining = [];
    
    Object.keys(allData.skus).forEach(sku => {
        const s = allData.skus[sku];
        if (s.recent_eff) {
            const diff = s.recent_eff - s.avg_eff;
            if (diff > 5) {
                improving.push({ sku, diff: diff.toFixed(1), hist: s.avg_eff, recent: s.recent_eff });
            } else if (diff < -5) {
                declining.push({ sku, diff: Math.abs(diff).toFixed(1), hist: s.avg_eff, recent: s.recent_eff });
            }
        }
    });
    
    document.getElementById('improvingList').innerHTML = improving.length 
        ? improving.map(s => `<strong>${s.sku}:</strong> ${s.hist}% ‚Üí ${s.recent}% (+${s.diff}pp)`).join('<br>')
        : 'No significant improvements detected (need >5pp change)';
    
    document.getElementById('decliningList').innerHTML = declining.length
        ? declining.map(s => `<strong>${s.sku}:</strong> ${s.hist}% ‚Üí ${s.recent}% (-${s.diff}pp)`).join('<br>')
        : 'No significant declines detected';
    
    // Find best and problem lines
    let bestLines = [];
    let problemLines = [];
    
    Object.keys(allData.lines).forEach(line => {
        const l = allData.lines[line];
        if (l.avg_eff >= 85) {
            bestLines.push({ line, eff: l.avg_eff, runs: l.runs });
        }
        if (l.avg_eff < 75) {
            problemLines.push({ line, eff: l.avg_eff, runs: l.runs, lost: l.total_lost_mins });
        }
    });
    
    document.getElementById('bestLinesList').innerHTML = bestLines.length
        ? bestLines.map(l => `<strong>${l.line}:</strong> ${l.eff}% avg (${l.runs} runs)`).join('<br>')
        : 'No lines averaging ‚â•85%';
    
    document.getElementById('problemLinesList').innerHTML = problemLines.length
        ? problemLines.map(l => `<strong>${l.line}:</strong> ${l.eff}% avg (${l.runs} runs, ${l.lost.toLocaleString()} lost mins) - Needs audit`).join('<br>')
        : 'All lines >75%';
}

// ===== INITIALIZE ON PAGE LOAD =====
window.addEventListener('DOMContentLoaded', function() {
    console.log('Dashboard loading...');
    console.log(`Total SKUs loaded: ${Object.keys(allData.skus).length}`);
    console.log(`Total Lines loaded: ${Object.keys(allData.lines).length}`);
    
    initCharts();
    populateTables();
    populateDropdowns();
    populateAnalysisLists();
    
    // Initialize detail views
    filterSKU();
    filterLine();
    
    console.log('Dashboard ready!');
});
</script>
</body>
</html>
